
<link rel="import" href="/polymer/bower_components/google-chart/google-chart.html">

<link rel="import" href="data.html">

  <polymer-element name="main-app">
  <template>

  <style>

   .intro {

    margin-top: 50px;
      margin-bottom: 20px;
   }

   .app-logo img {
      width: 62px;
      height: 63px;
      border-radius: 10px;
      border: 1px solid #aaa;
      overflow: hidden;
      margin-right: 20px;
   }

  #langlist {
    -webkit-column-count: 3; /* Chrome, Safari, Opera */
    -moz-column-count: 3; /* Firefox */
    column-count: 3;
 }

   #langlist label {
      clear: right;
      display: inline-block;
      margin: 5px;
   }

   .info {
      font-size: 30px;
      margin: 30px;
      margin-top: 60px;

   }

   google-chart {
    margin-left: 60px;
   }
  </style>


  <app-data countries="{{countries}}" langs="{{langs}}"></app-data>


	<h1>Mindale analytics</h1>

  <div id="langlist">
    
    <template repeat="{{item in langs_keys}}">

        <input on-tap="{{ redraw }}" type="checkbox" value="{{ item }}"  name="{{ item }}">
        <label for="{{ item }}">{{ item }}</label></br>
      
    </template>

  </div>

  <p>from: daria@mindale.com</p>
  <p>to: support@ticktick.com</p>
  <p>Subject: TickTick localization opportunities</p>
  
  <div class="intro">Hello,</br>
  My name is Daria Esaulova, I'm Head of Localization Services in mindale.com.</br>
  I found your amazing app <b>TickTick</b> in AppStore and want to show you some analytics report for your app.</div>

  <div horizontal layout center class="app-logo">
    <img src="http://a3.mzstatic.com/us/r30/Purple7/v4/11/1e/0b/111e0b18-3071-40d6-3d56-d56dbfd3804f/icon75x75.jpeg"/>
    <!--<img src="http://a1.mzstatic.com/us/r30/Purple7/v4/11/1e/0b/111e0b18-3071-40d6-3d56-d56dbfd3804f/icon175x175.jpeg"/>-->
    <div><h2>TickTick - your to-do list & task management</h2></div>
  </div>
  
   


    <div class="info">Ваше приложение могут установить всего в <b>{{app_cntrs}}</b> из <b>{{total_cntrs}}</b> стран</div>
  <google-chart id="geo" type='geo'>
  </google-chart>



<div class="info">Ваше приложение переведено только на <b>{{percent}}%</b> языков на которых говорят пользователи</div>

  <google-chart 
    id="pie"
    type='pie'>
  </google-chart>



<div class="info">Потенциальная аудитория вашего приложение всего <b>{{app_users}}</b> миллионов пользователей из <b>{{total_users}}</b> миллионов по всему миру</div>


 
 </template>

    <script>
         Polymer({

          total_cntrs: 0,
          total_users: 0,
          app_cntrs: 0,
          app_users: 0,
          percent: 0,

          getLangs: function () {
             var langs = [];
             var items = this.$.langlist.getElementsByTagName('input');

             for (var i=0; i < items.length; i++) {           
                 if (items[i].checked) {                 
                     langs.push(items[i].value);
                 } 
             }
             return langs;
          },   


          getCountries: function (langs) {
            var self = this;
            var cntrs = langs.reduce(function(prev, item) { 
                return prev.concat(self.langs[item]);
            }, []);

            cntrs = cntrs.filter(function(item, pos) {
                return cntrs.indexOf(item) == pos;
            });

            return this.countries.filter(function(item, pos) {
                return cntrs.indexOf(item[1]) >= 0;
            });
          },

          usersCount: function (items) {
              if (items.length === 0) {
                return 0;
              }
              var result = items.reduce(function(sum, item) {
                  return sum + item[2];
              }, 0);

              return parseInt((result/(3*Math.pow(10, 6))).toFixed(1));
          },


          redraw: function (e) { 

             var self = this;        

             var data = [['Code', 'Country',   'iOS Devices']];
                           
             var langs = this.getLangs();

             var app_cntrs  = this.getCountries(langs);
             this.app_users = this.usersCount(app_cntrs);
             this.app_cntrs = app_cntrs.length;

             
             this.total_users = this.usersCount(this.countries);
             this.total_cntrs = this.countries.length;


             console.log("Total users:", this.total_users, "App users:", this.app_users);

        
             for (i = 0; i < app_cntrs.length; i++) {
               data.push(app_cntrs[i]);
             }

             if (data.length > 1) {  
                this.$.geo.data = data;                   
             }
             else {
               this.$.geo.data = [['Code', 'Country',   'iOS Devices'],
                           ['KI', 'Kiribati', 0]];
             }
             //this.$.geo.drawChart();      


            var rows = this.langs_keys.map(function(item) {


             var cntrs  = self.getCountries([item]);
             var users = self.usersCount(cntrs);
              
                return [item, users];
            });

            rows = rows.sort(function (a,b) {

                if (a[1] > b[1]) {
                  return 1;
                }
                if (a[1] < b[1]) {
                  return -1;
                }
                return 0;
            });

            this.$.pie.rows = rows;

            this.percent = parseInt(this.app_users/(this.total_users/100));

             //this.$.pie.rows=[["Jan", 31],["Feb", 28],["Mar", 31],["Apr", 30],["May", 31],["Jun", 30]];
             //this.$.pie.drawChart();  
         },




          domReady: function () {

     
            

            this.langs_keys = Object.keys(this.langs);



              this.$.geo.options = {
                //region: '002', // Africa
                colorAxis: {colors: ['#00853f','#00853f']},
                //backgroundColor: '#81d4fa',
                backgroundColor: '#ffffff',
                datalessRegionColor: '#eee',
                defaultColor: '#f5f5f5',
              };
              
            //this.$.pie.options = {"title": "Distribution of days in 2001H1"};

            this.$.pie.options = {
               // colors: ['red','#004411']
              }

            
            this.$.pie.cols=[{"label": "Language", "type": "string"},{"label": "Uers", "type": "number"}];
            
            

         }
       });
      </script>

</polymer-element>
